<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Unclock</title>
    <meta name="description" content="Upload photogrammetry videos, filter by tags, switch views." />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
      /* ============================================================
         CSS CUSTOM PROPERTIES (THEME COLORS)
         ============================================================ */
      :root {
        --bg: #fff;
        --fg: #000;
        --muted: rgba(0,0,0,.75);
        --muted2: rgba(0,0,0,.45);
        --border: rgba(0,0,0,.10);
        --focus: rgba(0,0,0,.25);
        --pill: rgba(0,0,0,.08);
        --pill-active: rgba(0,0,0,.18);
        --tag-longevity: #2d8659;
        --tag-longevity-bg: rgba(45,134,89,.15);
        --tag-design: #1a73e8;
        --tag-design-bg: rgba(26,115,232,.15);
        --tag-society: #d97706;
        --tag-society-bg: rgba(217,119,6,.15);
        --tag-service: #7c3aed;
        --tag-service-bg: rgba(124,58,237,.15);
        --tag-system: #dc2626;
        --tag-system-bg: rgba(220,38,38,.15);
        --tag-technology: #0891b2;
        --tag-technology-bg: rgba(8,145,178,.15);
      }
      
      /* ============================================================
         BASE STYLES
         ============================================================ */
      * { box-sizing: border-box; margin: 0; padding: 0; }
      html, body { min-height: 100%; }
      body {
        background: var(--bg);
        color: var(--fg);
        font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        font-size: 14px;
        line-height: 1.5;
      }

      /* ============================================================
         LAYOUT
         ============================================================ */
      .wrap {
        max-width: 1100px;
        margin: 0 auto;
        padding: 28px 20px 80px;
        display: flex;
        flex-direction: column;
        gap: 22px;
      }

      .header-row {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
      }

      h1 { font-size: 18px; font-weight: 600; letter-spacing: .15px; }

      /* ============================================================
         TOOLBAR & BUTTONS
         ============================================================ */
      .toolbar {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        align-items: center;
      }

      .toolbar-divider {
        width: 1px;
        height: 20px;
        background: var(--border);
        margin: 0 4px;
      }

      .icon-btn {
        appearance: none;
  border: 1px solid var(--muted2);
  background: transparent;
  color: var(--muted);
        border-radius: 6px;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background .15s, color .15s;
      }
      .icon-btn:hover { background: var(--pill-active); color: var(--fg); }
      .icon-btn.active { background: var(--fg); 
  color: var(--bg);
  border-color: var(--fg);
}
      .icon-btn svg { width: 16px; height: 16px; }
   .icon-btn-red { 
  color: rgba(255,60,60,.85);
  border-color: rgba(255,60,60,.6);
}
.icon-btn-red:hover { 
  color: rgba(255,40,40,1); 
  background: rgba(255,60,60,.12);
  border-color: rgba(255,40,40,.8);
}
      .pill {
        appearance: none;
        border: none;
        background: var(--pill);
        color: var(--muted);
        border-radius: 999px;
        padding: 6px 14px;
        font-size: 12px;
        cursor: pointer;
        transition: background .15s, color .15s;
      }
      .pill:hover { background: var(--pill-active); color: var(--fg); }
      .pill.active { background: var(--pill-active); color: var(--fg); }

  
  .pill-text {
  appearance: none;
  border: 1px solid var(--muted2);
  background: transparent;
  color: var(--muted);
  border-radius: 6px;
  padding: 6px 14px;
  font-size: 12px;
  cursor: pointer;
  transition: background .15s, color .15s;
  height: 32px;
  display: inline-flex;
  align-items: center;
}
      .pill-text:hover { background: var(--pill-active); color: var(--fg); }
      .pill-text.active { background: var(--fg); color: var(--bg);
  border-color: var(--fg); }

      /* ============================================================
         TAG FILTERS
         ============================================================ */
      .filters {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        align-items: center;
      }
      .edit-panel.open ~ .filters {
  display: none;
}
      .filters .pill { 
        font-size: 11px; 
        padding: 5px 12px; 
        font-weight: 500;
        border: 1.5px solid currentColor;
        background: transparent;
        transition: all .15s;
      }
      .filters .pill[data-tag="longevity"] { color: var(--tag-longevity); }
      .filters .pill[data-tag="design"] { color: var(--tag-design); }
      .filters .pill[data-tag="society"] { color: var(--tag-society); }
      .filters .pill[data-tag="service"] { color: var(--tag-service); }
      .filters .pill[data-tag="system"] { color: var(--tag-system); }
      .filters .pill[data-tag="technology"] { color: var(--tag-technology); }
      .filters .pill:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,.1);
      }
      .filters .pill[data-tag].active { 
        background: currentColor;
        color: white;
        border-color: currentColor;
      }
      .filters .pill[data-tag="longevity"].active { background: var(--tag-longevity); }
      .filters .pill[data-tag="design"].active { background: var(--tag-design); }
      .filters .pill[data-tag="society"].active { background: var(--tag-society); }
      .filters .pill[data-tag="service"].active { background: var(--tag-service); }
      .filters .pill[data-tag="system"].active { background: var(--tag-system); }
      .filters .pill[data-tag="technology"].active { background: var(--tag-technology); }

      /* ============================================================
         UPLOAD FORM
         ============================================================ */
      .edit-panel {
        display: none;
        flex-direction: column;
        gap: 10px;
      }
      .edit-panel.open { display: flex; }

      label {
        display: block;
        font-size: 11px;
        color: var(--muted);
        margin-bottom: 4px;
        text-transform: uppercase;
        letter-spacing: .4px;
      }

      input[type="text"],
      input[type="date"],
      input[type="time"],
      textarea {
        width: 100%;
        padding: 9px 10px;
        border-radius: 8px;
        border: 1px solid var(--border);
        background: var(--bg);
        color: var(--fg);
        font-family: inherit;
        font-size: 13px;
        outline: none;
        color-scheme: dark;
      }
      input[type="text"]:focus,
      input[type="date"]:focus,
      input[type="time"]:focus,
      textarea:focus { border-color: var(--focus); }
      textarea { min-height: 80px; resize: vertical; }

      .file-input { 
      font-size: 14px; 
      color: var(--fg);
      padding: 8px 0;
      cursor: pointer;
      }
      
      .file-input-hidden {
  position: absolute;
  width: 1px;
  height: 1px;
  opacity: 0;
  overflow: hidden;
}

.file-input-button {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  appearance: none;
  border: 1px solid var(--muted2);
  background: transparent;
  color: var(--muted);
  border-radius: 6px;
  padding: 8px 16px;
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
  transition: all .15s;
  text-align: center;
}

.file-input-button::before {
  content: "üìÅ";
  font-size: 16px;
}

.file-input-button:hover {
  background: var(--pill-active);
  border-color: var(--fg);
  color: var(--fg);
}
.file-status {
  font-size: 12px;
  color: var(--muted);
  margin-top: 6px;
}

.file-status span {
  color: var(--fg);
  font-weight: 500;
}

      .tag-pills {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
      }
      .tag-pill {
        appearance: none;
        border: 1.5px solid currentColor;
        background: transparent;
        border-radius: 999px;
        padding: 5px 14px;
        font-size: 12px;
        cursor: pointer;
        transition: all .15s;
        font-weight: 500;
      }
      .tag-pill[data-tag="longevity"] { color: var(--tag-longevity); }
      .tag-pill[data-tag="design"] { color: var(--tag-design); }
      .tag-pill[data-tag="society"] { color: var(--tag-society); }
      .tag-pill[data-tag="service"] { color: var(--tag-service); }
      .tag-pill[data-tag="system"] { color: var(--tag-system); }
      .tag-pill[data-tag="technology"] { color: var(--tag-technology); }
      .tag-pill:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,.1);
      }
      .tag-pill.selected {
        background: currentColor;
        color: white;
        border-color: currentColor;
      }
      .tag-pill[data-tag="longevity"].selected { background: var(--tag-longevity); }
      .tag-pill[data-tag="design"].selected { background: var(--tag-design); }
      .tag-pill[data-tag="society"].selected { background: var(--tag-society); }
      .tag-pill[data-tag="service"].selected { background: var(--tag-service); }
      .tag-pill[data-tag="system"].selected { background: var(--tag-system); }
      .tag-pill[data-tag="technology"].selected { background: var(--tag-technology); }

      .form-actions {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 10px;
        margin-top: 10px;
      }
.btn-upload {
  appearance: none;
  border: 2px solid var(--fg);
  background: var(--fg);
  color: var(--bg);
  border-radius: 8px;
  padding: 14px 32px;
  font-size: 15px;
  font-weight: 700;
  letter-spacing: .5px;
  cursor: pointer;
  transition: all .15s;
  width: 100%;
  text-transform: uppercase;
}

.btn-upload:disabled { 
  opacity: .5; 
  cursor: default; 
}

.btn-upload:hover:not(:disabled) { 
  background: var(--muted);
  color: var(--bg);
  border-color: var(--fg);
  transform: translateY(-1px); 
}
      .btn-delete {
        appearance: none;
        border: 1px solid rgba(255,80,80,.25);
        background: rgba(255,60,60,.08);
        color: rgba(255,120,120,.9);
        border-radius: 6px;
        padding: 4px 12px;
        font-size: 11px;
        cursor: pointer;
        margin-top: 6px;
      }
      .btn-delete:hover { background: rgba(255,60,60,.18); }

      .word-count {
        font-size: 11px;
        color: var(--muted2);
      }

      .status-msg {
        font-size: 12px;
        color: var(--muted);
        text-align: center;
        width: 100%;
      }

      .progress-bar {
        width: 100%;
        height: 4px;
        background: var(--border);
        border-radius: 2px;
        overflow: hidden;
        margin-top: 4px;
      }

      .progress-fill {
        height: 100%;
        background: rgba(138,180,248,.8);
        transition: width .3s;
      }

      /* ============================================================
         VIDEO WALL LAYOUTS
         ============================================================ */
      .wall-single {
        display: flex;
        flex-direction: column;
        gap: 28px;
      }

      .wall-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 14px;
      }
      @media (max-width: 740px) {
        .wall-grid { grid-template-columns: repeat(2, 1fr); }
      }
      @media (max-width: 420px) {
        .wall-grid { grid-template-columns: 1fr;  }
      }
      
      @media (max-width: 768px) {
  #btnPreview, #btnGrid {
    display: none;
  }
}@media (max-width: 768px) {
  .icon-btn {
    width: 44px;
    height: 44px;
  }
  .pill-text {
    height: 44px;
  }
  .pill, .tag-pill {
    padding: 8px 16px;
    font-size: 13px;
  }
}



      /* ============================================================
         VIDEO CARDS
         ============================================================ */
      .card { padding: 0; }

      .card video {
        width: 100%;
        display: block;
        background: #000;
        border-radius: 6px;
      }

      .card .meta {
        padding: 10px 2px 4px;
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .card .tags-row {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        margin-bottom: 2px;
      }
      .card .tag {
        font-size: 10px;
        padding: 2px 8px;
        border-radius: 999px;
        font-weight: 500;
      }
    .tag-longevity { 
        background: var(--tag-longevity); 
        color: white;
        border: 1.5px solid var(--tag-longevity);
      }
      .tag-design { 
        background: var(--tag-design); 
        color: white;
        border: 1.5px solid var(--tag-design);
      }
      .tag-society { 
        background: var(--tag-society); 
        color: white;
        border: 1.5px solid var(--tag-society);
      }
      .tag-service { 
        background: var(--tag-service); 
        color: white;
        border: 1.5px solid var(--tag-service);
      }
      .tag-system { 
        background: var(--tag-system); 
        color: white;
        border: 1.5px solid var(--tag-system);
      }
      .tag-technology { 
        background: var(--tag-technology); 
        color: white;
        border: 1.5px solid var(--tag-technology);
      }

      .card .meta-line {
        font-size: 12px;
        color: var(--muted2);
      }

      .card .insight-text {
        font-size: 13px;
        color: var(--muted);
        margin-top: 2px;
        line-height: 1.5;
      }

      .wall-grid .card .meta { padding: 5px 2px 2px; }
      .wall-grid .card .meta-line { font-size: 9px; }
      .wall-grid .card .tag { font-size: 8px; padding: 1px 6px; }
      .wall-grid .card .insight-text { font-size: 10px; }

      /* ============================================================
         UTILITY CLASSES
         ============================================================ */
      .empty-state {
        padding: 24px 0;
        color: var(--muted2);
        font-size: 13px;
      }

      .separator {
        height: 1px;
        background: var(--border);
      }
    </style>
  </head>
  <body>
    <!-- Main container wrapper -->
    <div class="wrap">
      
      <!-- Header section with title and toolbar controls -->
      <div class="header-row">
        <h1>Unclock Photogrammetry Archive</h1>
        
        <!-- Toolbar with upload, sort, view, and export controls -->
        <div class="toolbar">
          <!-- Upload toggle button -->
          <button class="pill-text" id="btnEdit">Add Video</button>

          <span class="toolbar-divider"></span>

          <!-- View mode toggles: single column or grid -->
          <button class="icon-btn active" id="btnPreview" title="Single column">
            <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round">
              <rect x="2" y="2" width="12" height="12" rx="1.5" />
            </svg>
          </button>
          <button class="icon-btn" id="btnGrid" title="Grid view">
            <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round">
              <rect x="1.5" y="1.5" width="5" height="5" rx="1" />
              <rect x="9.5" y="1.5" width="5" height="5" rx="1" />
              <rect x="1.5" y="9.5" width="5" height="5" rx="1" />
              <rect x="9.5" y="9.5" width="5" height="5" rx="1" />
            </svg>
          </button>
          
          <!-- Export to CSV button -->
          <button class="icon-btn" id="btnExport" title="Export CSV">
            <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
              <path d="M8 2v8" />
              <polyline points="4 7 8 10 12 7" />
              <path d="M2 13h12" />
            </svg>
          </button>
          
          <!-- Reset wall button (deletes all videos) -->
          <button class="icon-btn icon-btn-red" id="btnRefresh" title="Reset wall">
            <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round">
              <path d="M3 3l10 10M13 3L3 13" />
            </svg>
          </button>
        </div>
      </div>

      <!-- Upload form panel (hidden by default) -->
      <div class="edit-panel" id="editPanel">
        <div class="separator"></div>
        
        <!-- Video upload form with metadata fields -->
        <form id="uploadForm" style="display:flex;flex-direction:column;gap:18px;">
          
          <!-- Tags selection (allows multiple) -->
          <div>
            <label>Tags</label>
            <div class="tag-pills" id="tagPills">
              <button type="button" class="tag-pill" data-tag="longevity">longevity</button>
              <button type="button" class="tag-pill" data-tag="design">design</button>
              <button type="button" class="tag-pill" data-tag="society">society</button>
              <button type="button" class="tag-pill" data-tag="service">service</button>
              <button type="button" class="tag-pill" data-tag="system">system</button>
              <button type="button" class="tag-pill" data-tag="technology">technology</button>
            </div>
          </div>
          
          <!-- File upload input (max 50MB) -->
          <div>
            <label for="file">Video file (max 50MB)</label>
            <input class="file-input-hidden" id="file" name="file" type="file" accept="video/*" required />
          <label for="file" class="file-input-button">Choose Video File</label>
<div class="file-status" id="fileStatus" style="display:none;">Ready to upload: <span id="fileName"></span></div>

          </div>
          
          <!-- Time input -->
          <div>
            <label for="time">Time</label>
            <input id="time" name="time" type="time" />
          </div>
          
          <!-- Date input -->
          <div>
            <label for="date">Date</label>
            <input id="date" name="date" type="date" />
          </div>
          
          <!-- Location text input -->
          <div>
            <label for="location">Location</label>
            <input id="location" name="location" type="text" placeholder="e.g. Brooklyn" />
          </div>
          
          <!-- Insight textarea (350 word limit) -->
          <div>
            <label for="insight">Observations <span class="word-count" id="wordCount">(0 / 350 words)</span></label>
            <textarea id="insight" name="insight" placeholder="What did you observe about [your pillar] through [your lens] at MIT Museum?"></textarea>
          </div>
          
          <!-- Submit button and status message -->
          <div class="form-actions">
            <button class="btn-upload" id="submitBtn" type="submit">Upload</button>
            <span class="status-msg" id="status"></span>
          </div>
          
          <!-- Upload progress bar (hidden until uploading) -->
          <div class="progress-bar" id="progressBar" style="display:none;">
            <div class="progress-fill" id="progressFill"></div>
          </div>
        </form>
        
        <div class="separator"></div>
      </div>

      <!-- Tag filter pills for filtering displayed videos -->
      <div class="filters" id="filtersBar">
        <button class="pill" data-tag="longevity">longevity</button>
        <button class="pill" data-tag="design">design</button>
        <button class="pill" data-tag="society">society</button>
        <button class="pill" data-tag="service">service</button>
        <button class="pill" data-tag="system">system</button>
        <button class="pill" data-tag="technology">technology</button>
      </div>

      <!-- Video wall container (populated dynamically by JavaScript) -->
      <div id="wall"></div>
    </div>

    <script>
      // ============================================================
      // CONFIGURATION CONSTANTS
      // ============================================================
      
      const CONFIG = {
        // Supabase connection
        SUPABASE_URL: 'https://acjtqcvqoqlwstpurnnt.supabase.co',
        SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFjanRxY3Zxb3Fsd3N0cHVybm50Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA5OTQ0MTksImV4cCI6MjA4NjU3MDQxOX0.ulDc5xjs68zAXaIfM8nP1tWyobRKaI61FBf1IPrhyXM',
        
        // Upload limits
        MAX_VIDEO_SIZE_MB: 50,
        MAX_VIDEO_SIZE_BYTES: 50 * 1024 * 1024,
        MAX_VIDEOS: 20,
        MAX_INSIGHT_WORDS: 350,
        
        // UI timing
        STATUS_MESSAGE_DURATION: 3000, // milliseconds
        
        // Grid truncation
        GRID_INSIGHT_TRUNCATE_LENGTH: 80
      };
      
      // ============================================================
      // INITIALIZE SUPABASE CLIENT
      // ============================================================
      
      const supabaseClient = window.supabase.createClient(
        CONFIG.SUPABASE_URL, 
        CONFIG.SUPABASE_ANON_KEY
      );
      
      // ============================================================
      // DOM ELEMENT REFERENCES
      // ============================================================
      
      const wallEl = document.getElementById('wall');
      const formEl = document.getElementById('uploadForm');
      const statusEl = document.getElementById('status');
      const submitBtn = document.getElementById('submitBtn');
      const editPanel = document.getElementById('editPanel');
      const btnEdit = document.getElementById('btnEdit');
      const btnPreview = document.getElementById('btnPreview');
      const btnGrid = document.getElementById('btnGrid');
      const btnRefresh = document.getElementById('btnRefresh');
      const btnExport = document.getElementById('btnExport');
      const filtersBar = document.getElementById('filtersBar');
      const insightEl = document.getElementById('insight');
      const wordCountEl = document.getElementById('wordCount');
      const tagPillsEl = document.getElementById('tagPills');
      const fileInput = document.getElementById('file');
      const progressBar = document.getElementById('progressBar');
      const progressFill = document.getElementById('progressFill');
      const fileStatus = document.getElementById('fileStatus');
      const fileNameSpan = document.getElementById('fileName');

      // ============================================================
      // APPLICATION STATE
      // ============================================================
      
      let allVideos = [];              // All videos from database
      let viewMode = 'single';         // 'single' or 'grid' view mode
      let editMode = false;            // Whether edit panel is open
      let activeTags = new Set();      // Currently active filter tags
      let selectedFormTags = new Set(); // Tags selected in upload form

      // Tag color mapping for visual consistency
      const TAG_COLORS = {
        longevity: 'tag-longevity',
        design: 'tag-design',
        society: 'tag-society',
        service: 'tag-service',
        system: 'tag-system',
        technology: 'tag-technology'
      };

      // ============================================================
      // UTILITY FUNCTIONS
      // ============================================================
      
      /**
       * Escape HTML special characters to prevent XSS
       * @param {string} s - String to escape
       * @returns {string} Escaped string
       */
      function esc(s) {
        return String(s ?? '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
      }

      /**
       * Count words in text (used for insight character limit)
       * @param {string} text - Text to count
       * @returns {number} Word count
       */
      function countWords(text) {
        return text.trim().split(/\s+/).filter(Boolean).length;
      }

      /**
       * Format 24-hour time to 12-hour format with AM/PM
       * @param {string} val - Time in HH:MM format
       * @returns {string} Formatted time string
       */
      function formatTime(val) {
        if (!val) return '';
        const [h, m] = val.split(':');
        const hour = parseInt(h, 10);
        const ampm = hour >= 12 ? 'PM' : 'AM';
        const h12 = hour % 12 || 12;
        return h12 + ':' + m + ' ' + ampm;
      }

      /**
       * Format date value (currently just returns as-is)
       * @param {string} val - Date string
       * @returns {string} Formatted date
       */
      function formatDate(val) {
        if (!val) return '';
        return val;
      }

      /**
       * Show temporary status message
       * @param {string} message - Message to display
       * @param {number} duration - How long to show (milliseconds)
       */
      function showStatus(message, duration = CONFIG.STATUS_MESSAGE_DURATION) {
        statusEl.textContent = message;
        setTimeout(() => statusEl.textContent = '', duration);
      }

      // ============================================================
      // VIDEO FILTERING LOGIC
      // ============================================================
      
      /**
       * Get filtered videos based on active tags
       * @returns {Array} Filtered video array (newest first)
       */
      function getFilteredVideos() {
        // Start with newest first (reverse chronological)
        let items = allVideos.slice().reverse();
        
        // Apply tag filters if any tags are active
        if (activeTags.size > 0) {
          items = items.filter(v => {
            const vTags = Array.isArray(v.tags) ? v.tags : [];
            return [...activeTags].some(t => vTags.includes(t));
          });
        }
        
        return items;
      }

      // ============================================================
      // RENDERING FUNCTIONS
      // ============================================================
      
      /**
       * Render the video wall based on current state
       * Handles both grid and single column views
       */
      function renderWall() {
        const items = getFilteredVideos();
        
        // Show empty state if no videos match filters
        if (items.length === 0) {
          wallEl.className = '';
          wallEl.innerHTML = '<div class="empty-state">No videos to show. Click "Add Video" to upload your first video!</div>';
          return;
        }

        // Set layout class based on view mode
        wallEl.className = viewMode === 'grid' ? 'wall-grid' : 'wall-single';
        const isGrid = viewMode === 'grid';
        
        // Generate HTML for each video card
        wallEl.innerHTML = items.map(v => {
          const vTags = Array.isArray(v.tags) ? v.tags : [];
          
          // Build tags row
          const tagsHtml = vTags.length > 0
            ? '<div class="tags-row">' + vTags.map(t => 
                `<span class="tag ${TAG_COLORS[t] || ''}">${esc(t)}</span>`
              ).join('') + '</div>'
            : '';

          // Build metadata line (time ‚Ä¢ date ‚Ä¢ location)
          const metaParts = [];
          if (v.time) metaParts.push(esc(formatTime(v.time)));
          if (v.date) metaParts.push(esc(formatDate(v.date)));
          if (v.location) metaParts.push(esc(v.location));
          const metaLine = metaParts.length > 0
            ? `<div class="meta-line">${metaParts.join(' &bull; ')}</div>`
            : '';

          // Build insight text (truncated in grid view)
          const insightText = v.insight
            ? `<div class="insight-text">${
                isGrid 
                  ? esc((v.insight || '').slice(0, CONFIG.GRID_INSIGHT_TRUNCATE_LENGTH) + 
                      ((v.insight || '').length > CONFIG.GRID_INSIGHT_TRUNCATE_LENGTH ? '\u2026' : ''))
                  : esc(v.insight)
              }</div>`
            : '';

          // Show delete button only in edit mode
          const deleteBtn = editMode
            ? `<button class="btn-delete" onclick="deleteVideo(${v.id})">Delete</button>`
            : '';

          return `<div class="card">
            <video src="${v.video_url}" ${isGrid ? '' : 'controls'} playsinline autoplay muted loop preload="metadata"></video>
            <div class="meta">
              ${tagsHtml}
              ${metaLine}
              ${insightText}
              ${deleteBtn}
            </div>
          </div>`;
        }).join('');
      }

      // ============================================================
      // DATA MANAGEMENT FUNCTIONS
      // ============================================================
      
      /**
       * Load all videos from database and render wall
       * Called on page load and after uploads/deletes
       */
      async function loadWall() {
        try {
          const { data, error } = await supabaseClient
            .from('videos')
            .select('*')
            .order('created_at', { ascending: true });
          
          if (error) throw error;
          
          allVideos = data || [];
          renderWall();
        } catch (err) {
          console.error('Error loading videos:', err);
          wallEl.className = '';
          wallEl.innerHTML = '<div class="empty-state">Failed to load videos. Please refresh the page.</div>';
        }
      }

      /**
       * Delete a video (both from storage and database)
       * @param {number} id - Video ID to delete
       */
      window.deleteVideo = async function(id) {
        if (!confirm('Delete this video?')) return;
        
        try {
          const video = allVideos.find(v => v.id === id);
          if (!video) return;
          
          // Extract filename from URL and delete from storage
          const filename = video.video_url.split('/').pop();
          await supabaseClient.storage.from('videos').remove([filename]);
          
          // Delete database record
          await supabaseClient.from('videos').delete().eq('id', id);
          
          await loadWall();
          showStatus('Video deleted.');
        } catch (err) {
          alert('Failed to delete video: ' + err.message);
        }
      };

      /**
       * Reset the entire wall (delete all videos)
       * Used by the reset button
       */
      async function resetWall() {
        if (!confirm('Are you sure you want to reset the wall? This will delete ALL videos permanently.')) {
          return;
        }
        
        try {
          statusEl.textContent = 'Deleting videos...';
          
          // Delete all files from storage
          const { data: files } = await supabaseClient.storage.from('videos').list();
          if (files) {
            const filesToRemove = files.map(f => f.name);
            await supabaseClient.storage.from('videos').remove(filesToRemove);
          }
          
          // Delete all database records
          await supabaseClient.from('videos').delete().neq('id', 0);
          
          await loadWall();
          showStatus('Wall reset successfully.');
        } catch (err) {
          statusEl.textContent = 'Reset failed: ' + err.message;
        }
      }

      /**
       * Export all videos to CSV file
       * Generates downloadable CSV with all video metadata
       */
      async function exportToCSV() {
        try {
          if (allVideos.length === 0) {
            alert('No videos to export.');
            return;
          }

          // Build CSV header
          const csvRows = [
            ['ID', 'Filename', 'Time', 'Date', 'Location', 'Tags', 'Insight', 'Video URL', 'Created At'].join(',')
          ];

          // Add each video as a row
          for (const video of allVideos) {
            const row = [
              video.id,
              video.filename || '',
              video.time || '',
              video.date || '',
              video.location || '',
              video.tags || '',
              (video.insight || '').replace(/"/g, '""'), // Escape quotes in insight
              video.video_url || '',
              video.created_at || ''
            ];
            csvRows.push(row.map(v => `"${v}"`).join(','));
          }

          // Create blob and trigger download
          const csvContent = csvRows.join('\n');
          const csvBlob = new Blob([csvContent], { type: 'text/csv' });
          const csvUrl = URL.createObjectURL(csvBlob);
          
          const csvLink = document.createElement('a');
          csvLink.href = csvUrl;
          csvLink.download = `video-wall-export-${Date.now()}.csv`;
          csvLink.click();
          URL.revokeObjectURL(csvUrl);

          showStatus('CSV exported successfully!');
        } catch (err) {
          alert('Export failed: ' + err.message);
        }
      }

      // ============================================================
      // EVENT LISTENERS - TAG SELECTION IN FORM
      // ============================================================
      
      tagPillsEl.addEventListener('click', (e) => {
        const pill = e.target.closest('.tag-pill');
        if (!pill) return;
        
        const tag = pill.dataset.tag;
        if (selectedFormTags.has(tag)) {
          selectedFormTags.delete(tag);
          pill.classList.remove('selected');
        } else {
          selectedFormTags.add(tag);
          pill.classList.add('selected');
        }
      });

      // ============================================================
      // EVENT LISTENERS - WORD COUNT
      // ============================================================
      
      insightEl.addEventListener('input', () => {
        const wc = countWords(insightEl.value);
        wordCountEl.textContent = `(${wc} / ${CONFIG.MAX_INSIGHT_WORDS} words)`;
        wordCountEl.style.color = wc > CONFIG.MAX_INSIGHT_WORDS ? '#f87171' : '';
      });

      // ============================================================
      // EVENT LISTENERS - VIEW CONTROLS
      // ============================================================
      
      btnEdit.addEventListener('click', () => {
        editMode = !editMode;
        editPanel.classList.toggle('open', editMode);
        btnEdit.classList.toggle('active', editMode);
        renderWall();
      });

      btnPreview.addEventListener('click', () => {
        viewMode = 'single';
        btnPreview.classList.add('active');
        btnGrid.classList.remove('active');
        renderWall();
      });

      btnGrid.addEventListener('click', () => {
        viewMode = 'grid';
        btnGrid.classList.add('active');
        btnPreview.classList.remove('active');
        renderWall();
      });

      btnRefresh.addEventListener('click', resetWall);
      btnExport.addEventListener('click', exportToCSV);

      // ============================================================
      // EVENT LISTENERS - TAG FILTERS
      // ============================================================
      
     filtersBar.addEventListener('click', (e) => {
        const btn = e.target.closest('[data-tag]');
        if (!btn) return;
        const tag = btn.dataset.tag;

        // Toggle individual tag filter
        btn.classList.toggle('active');
        
        if (btn.classList.contains('active')) {
          activeTags.add(tag);
        } else {
          activeTags.delete(tag);
        }
        
 
        
        renderWall();
      });

     

      // ============================================================
      // EVENT LISTENERS - FORM SUBMISSION
      // ============================================================
      
      formEl.addEventListener('submit', async (e) => {
        e.preventDefault();
        statusEl.textContent = '';
        progressBar.style.display = 'none';

        // Validate word count
        const wc = countWords(insightEl.value);
        if (wc > CONFIG.MAX_INSIGHT_WORDS) {
          statusEl.textContent = `Insight exceeds ${CONFIG.MAX_INSIGHT_WORDS} words.`;
          return;
        }

        // Validate file selection
        const file = fileInput.files[0];
        if (!file) {
          statusEl.textContent = 'Please choose a video file.';
          return;
        }

        // Validate file size
        if (file.size > CONFIG.MAX_VIDEO_SIZE_BYTES) {
          statusEl.textContent = `Video must be under ${CONFIG.MAX_VIDEO_SIZE_MB}MB.`;
          return;
        }

        // Check video limit
        if (allVideos.length >= CONFIG.MAX_VIDEOS) {
          statusEl.textContent = `Maximum of ${CONFIG.MAX_VIDEOS} videos reached. Delete some videos first.`;
          return;
        }

        // Start upload
        submitBtn.disabled = true;
        statusEl.textContent = 'Uploading video...';
        progressBar.style.display = 'block';
        progressFill.style.width = '0%';

        try {
          // Upload file to Supabase storage
          const fileExt = file.name.split('.').pop();
          const fileName = `${Date.now()}.${fileExt}`;
          
          const { data: uploadData, error: uploadError } = await supabaseClient.storage
            .from('videos')
            .upload(fileName, file);

          if (uploadError) throw uploadError;

          progressFill.style.width = '100%';

          // Get public URL for the uploaded file
          const { data: urlData } = supabaseClient.storage
            .from('videos')
            .getPublicUrl(fileName);

          // Save metadata to database
          const { error: dbError } = await supabaseClient
            .from('videos')
            .insert({
              filename: file.name,
              time: document.getElementById('time').value,
              date: document.getElementById('date').value,
              location: document.getElementById('location').value,
              insight: insightEl.value,
              tags: [...selectedFormTags],
              video_url: urlData.publicUrl
            });

          if (dbError) throw dbError;

          // Reset form
          formEl.reset();
          selectedFormTags.clear();
          tagPillsEl.querySelectorAll('.tag-pill').forEach(p => p.classList.remove('selected'));
          wordCountEl.textContent = `(0 / ${CONFIG.MAX_INSIGHT_WORDS} words)`;
          fileStatus.style.display = 'none';
          progressBar.style.display = 'none';



          
          // Reload wall with new video
          await loadWall();
          showStatus('Video uploaded successfully!');
        } catch (err) {
          statusEl.textContent = 'Upload failed: ' + err.message;
          progressBar.style.display = 'none';
          console.error('Upload error:', err);
        } finally {
          submitBtn.disabled = false;
        }
      });
   // Show selected file status
fileInput.addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (file) {
    fileNameSpan.textContent = file.name;
    fileStatus.style.display = 'block';
  } else {
    fileStatus.style.display = 'none';
  }
});

      // ============================================================
      // INITIALIZATION
      // ============================================================
      
      // Load videos when page loads
      loadWall();
    </script>
  </body>
</html>
